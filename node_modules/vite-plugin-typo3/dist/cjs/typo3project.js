"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = typo3project;
const node_path_1 = require("node:path");
const vite_1 = require("vite");
const picocolors_1 = __importDefault(require("picocolors"));
const utils_js_1 = require("./utils.js");
function typo3project(userConfig = {}) {
    const logger = (0, vite_1.createLogger)("info", { prefix: "[plugin-typo3-project]" });
    let pluginConfig;
    let availableExtensions;
    let entrypoints;
    return {
        name: "vite-plugin-typo3-project",
        config(config, env) {
            // Don't watch files in irrelevant/temporary TYPO3 directories
            // This prevents performance issues and avoids file system problems
            config.server ??= {};
            config.server.watch ??= {};
            config.server.watch.ignored ??= (0, utils_js_1.getDefaultIgnoreList)();
            try {
                pluginConfig = (0, utils_js_1.initializePluginConfig)(userConfig, config.root ?? process.cwd());
            }
            catch (err) {
                logger.error(picocolors_1.default.red(err.message), { timestamp: true });
                return;
            }
            if (env.command === "serve" && env.mode === "production") {
                logger.warn(picocolors_1.default.yellow("Running the dev server with vite-plugin-typo3 in production mode is not recommended and might have security implications."), { timestamp: true });
            }
            // Set CORS headers to prevent leakage of source code to third-parties
            config.server ??= {};
            config.server.cors ??= {
                origin: (0, utils_js_1.getDefaultAllowedOrigins)(),
            };
            // Allow access to vite dev server through reverse proxy in DDEV setups
            if (process.env.IS_DDEV_PROJECT &&
                config.server.allowedHosts !== true) {
                config.server.allowedHosts ??= [];
                config.server.allowedHosts.push(".ddev.site");
            }
            // Set empty base path to enable relative paths in generated assets (e. g. CSS files)
            config.base ??= "";
            // Disable public dir since TYPO3 already has plenty of options to serve static files
            config.publicDir ??= false;
            // Enable source maps for CSS files in dev environment
            config.css ??= {};
            config.css.devSourcemap ??= true;
            // Setup build destination folder
            config.build ??= {};
            config.build.manifest ??= true;
            config.build.outDir ??= (0, node_path_1.join)(pluginConfig.composerContext.path, pluginConfig.composerContext.webDir, "_assets/vite/");
            // Extract relevant TYPO3 extensions from composer metadata
            availableExtensions = (0, utils_js_1.determineAvailableTypo3Extensions)(pluginConfig.composerContext);
            // Add path alias for each extension
            config.resolve ??= {};
            config.resolve.alias = (0, utils_js_1.addAliases)(config.resolve.alias, availableExtensions, pluginConfig.aliases);
            // Find all vite entrypoints in relevant TYPO3 extensions
            entrypoints = (0, utils_js_1.findEntrypointsInExtensions)(availableExtensions, pluginConfig.entrypointFile, pluginConfig.entrypointIgnorePatterns);
            if (!entrypoints.length) {
                logger.warn(picocolors_1.default.red("No entrypoints from TYPO3 extensions have been picked up. Make sure that you create at least one 'Configuration/ViteEntrypoints.json' file."), { timestamp: true });
            }
            // Add entrypoints to rollup config while preserving entrypoints that were added manually
            config.build.rollupOptions ??= {};
            config.build.rollupOptions.input = (0, utils_js_1.addRollupInputs)(config.build.rollupOptions.input, entrypoints);
        },
        configResolved(config) {
            if (!pluginConfig) {
                return;
            }
            if (config.build.manifest === false) {
                logger.warn(picocolors_1.default.red("'config.build.manifest' is set to 'false', which might lead to problems with TYPO3."), { timestamp: true });
            }
            if (pluginConfig.debug) {
                (0, utils_js_1.outputDebugInformation)(availableExtensions, entrypoints, pluginConfig.composerContext, logger, pluginConfig.aliases);
            }
        },
    };
}
//# sourceMappingURL=typo3project.js.map